---
import ThemeToggle from "./ThemeToggle.astro";
import { getLangFromUrl, useTranslations } from "../utils/i18n";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const toolCategories = [
  {
    name: t("category.formatters"),
    icon: "âœ¨",
    tools: [
      { name: t("tools.jsonFormatter"), href: "/tools/json-formatter", icon: "ğŸ“‹" },
      { name: t("tools.base64"), href: "/tools/base64-tool", icon: "ğŸ”" },
      { name: t("tools.cssFormatter"), href: "/tools/css-formatter", icon: "ğŸ¨" },
      { name: t("tools.sqlFormatter"), href: "/tools/sql-formatter", icon: "ğŸ—ƒï¸" },
      { name: "JS Minifier", href: "/tools/js-minifier", icon: "ğŸ“¦" },
      { name: "CSS Bridge", href: "/tools/css-converter", icon: "ğŸŒ‰" },
    ],
  },
  {
    name: t("category.generators"),
    icon: "âš¡",
    tools: [
      { name: t("tools.uuidGenerator"), href: "/tools/uuid-generator", icon: "ğŸ²" },
      { name: t("tools.hashGenerator"), href: "/tools/hash-generator", icon: "ğŸ”’" },
      { name: t("tools.loremGenerator"), href: "/tools/lorem-generator", icon: "ğŸ“" },
      {
        name: t("tools.passwordGenerator"),
        href: "/tools/password-generator",
        icon: "ğŸ”‘",
      },
      { name: t("tools.qrGenerator"), href: "/tools/qr-generator", icon: "ğŸ“±" },
      { name: "PWA Manifest", href: "/tools/pwa-manifest", icon: "ğŸ“±" },
    ],
  },
  {
    name: t("category.converters"),
    icon: "ğŸ”„",
    tools: [
      { name: t("tools.colorConverter"), href: "/tools/color-converter", icon: "ğŸŒˆ" },
      {
        name: t("tools.timestampConverter"),
        href: "/tools/timestamp-converter",
        icon: "â°",
      },
      { name: t("tools.urlCodec"), href: "/tools/url-codec", icon: "ğŸ”—" },
      { name: t("tools.htmlEntity"), href: "/tools/html-entity-encoder", icon: "ğŸ”¤" },
      { name: t("tools.jsonToTs"), href: "/tools/json-to-typescript", icon: "ğŸ”·" },
      { name: "HTML Bridge", href: "/tools/html-converter", icon: "ğŸŒ‰" },
    ],
  },
  {
    name: t("category.validators"),
    icon: "âœ…",
    tools: [
      { name: t("tools.regexTester"), href: "/tools/regex-tester", icon: "ğŸ”" },
      { name: "AutoRegex (AI)", href: "/tools/auto-regex", icon: "ğŸ¤–" },
      { name: "A11y Lab", href: "/tools/a11y-lab", icon: "â™¿" },
      { name: "HTTP Studio", href: "/tools/http-client", icon: "ğŸŒ" },
      { name: "Performance Lab", href: "/tools/performance-lab", icon: "ğŸš€" },
      { name: t("tools.jwtDecoder"), href: "/tools/jwt-decoder", icon: "ğŸ«" },
      { name: t("tools.cronParser"), href: "/tools/cron-parser", icon: "â±ï¸" },
    ],
  },
  {
    name: t("category.textTools"),
    icon: "ğŸ“",
    tools: [
      {
        name: t("tools.markdownPreview"),
        href: "/tools/markdown-preview",
        icon: "ğŸ“„",
      },
      { name: t("tools.diffChecker"), href: "/tools/diff-checker", icon: "ğŸ“Š" },
      { name: "HTML Lab", href: "/tools/html-editor", icon: "ğŸ§ª" },
      { name: "Layout Lab", href: "/tools/layout-generator", icon: "â–¢" },
    ],
  },
];
const currentPath = Astro.url.pathname;
---

<aside
  class="fixed left-0 top-16 h-[calc(100vh-4rem)] w-72 glass-card border-r border-slate-200/50 dark:border-slate-700/50 hidden md:block overflow-y-auto transition-all duration-300"
>
  <div class="p-5">
    <div class="flex justify-between items-center mb-6">
      <h2
        class="text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2"
      >
        <span class="text-xl">ğŸ§°</span>
        {t("sidebar.devTools")}
      </h2>
    </div>

    <div class="space-y-4" id="sidebar-categories">
      {
        toolCategories.map((category, idx) => (
          <div class="category-group" data-category-id={idx}>
            <button
              class="w-full flex items-center justify-between px-3 py-2 text-sm font-black text-slate-500 dark:text-slate-400 uppercase tracking-wider hover:bg-slate-100 dark:hover:bg-slate-800/50 rounded-xl transition-colors group"
              aria-expanded="false"
            >
              <div class="flex items-center gap-2">
                <span>{category.icon}</span>
                <span>{category.name}</span>
            </div>
            <svg
                class="w-4 h-4 transition-transform duration-300 transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>
            <ul class="space-y-1 mt-1 overflow-hidden transition-all duration-300 max-h-0 opacity-0 category-content">
              {category.tools.map((tool) => (
                <li>
                  <a
                    href={tool.href}
                    class:list={[
                      "flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all duration-200 group",
                      currentPath === tool.href
                        ? "bg-gradient-to-r from-accent-500/10 to-primary-500/10 text-accent-600 dark:text-accent-400"
                        : "text-slate-700 dark:text-slate-200 hover:bg-gradient-to-r hover:from-accent-500/10 hover:to-primary-500/10 hover:text-accent-600 dark:hover:text-accent-400",
                    ]}
                  >
                    <span class="text-lg group-hover:scale-110 transition-transform duration-200">
                      {tool.icon}
                    </span>
                    <span class="font-medium text-sm">{tool.name}</span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))
      }
    </div>
  </div>
</aside>

<script>
  function setupSidebar() {
    const categories = document.querySelectorAll(".category-group");
    const storageKey = "devtools-sidebar-state";

    // Load saved state
    const savedState = JSON.parse(localStorage.getItem(storageKey) || "{}");

    categories.forEach((group, idx) => {
      const btn = group.querySelector("button");
      const content = group.querySelector(".category-content") as HTMLElement;
      const arrow = btn?.querySelector("svg");
      const categoryId =
        group.getAttribute("data-category-id") || idx.toString();

      const isOpen = savedState[categoryId] === true;

      const updateUI = (open: boolean) => {
        if (open) {
          content.style.maxHeight = content.scrollHeight + "px";
          content.style.opacity = "1";
          arrow?.classList.add("rotate-180");
          btn?.setAttribute("aria-expanded", "true");
        } else {
          content.style.maxHeight = "0";
          content.style.opacity = "0";
          arrow?.classList.remove("rotate-180");
          btn?.setAttribute("aria-expanded", "false");
        }
      };

      // Initial state
      updateUI(isOpen);

      btn?.addEventListener("click", () => {
        const currentlyOpen = btn.getAttribute("aria-expanded") === "true";
        const newState = !currentlyOpen;

        updateUI(newState);

        // Save state
        const currentState = JSON.parse(
          localStorage.getItem(storageKey) || "{}",
        );
        currentState[categoryId] = newState;
        localStorage.setItem(storageKey, JSON.stringify(currentState));
      });
    });
  }

  setupSidebar();
  // Support Astro transitions
  document.addEventListener("astro:after-swap", setupSidebar);
</script>

<style>
  aside::-webkit-scrollbar {
    width: 4px;
  }

  aside::-webkit-scrollbar-thumb {
    background: rgba(168, 85, 247, 0.2);
    border-radius: 2px;
  }

  .category-content {
    transition:
      max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.3s ease-in-out;
  }
</style>
