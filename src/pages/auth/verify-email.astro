---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { db } from "../../lib/db";
import { verificationTokens, users } from "../../lib/db/auth-schema";
import { eq } from "drizzle-orm";

const token = Astro.url.searchParams.get("token");
let message = "Verifying your email...";
let success = false;

if (token) {
    const verificationToken = await db.query.verificationTokens.findFirst({
        where: eq(verificationTokens.token, token),
    });

    if (verificationToken && verificationToken.expires > new Date()) {
        await db
            .update(users)
            .set({ emailVerified: new Date() })
            .where(eq(users.email, verificationToken.identifier));

        await db
            .delete(verificationTokens)
            .where(eq(verificationTokens.token, token));

        message =
            "Email verified successfully! You can now access all features.";
        success = true;
    } else {
        message = "Invalid or expired verification link.";
    }
} else {
    message = "Verification token is missing.";
}
---

<AuthLayout title="Verify Email - Multi-Tools">
    <div class="max-w-md w-full text-center">
        <div
            class="relative bg-slate-900/80 backdrop-blur-xl border border-slate-800 rounded-[2rem] p-10 shadow-2xl overflow-hidden"
        >
            <!-- Gradient accent bar -->
            <div
                class={`absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r ${success ? "from-emerald-500 via-green-500 to-emerald-500" : "from-rose-500 via-red-500 to-rose-500"}`}
            >
            </div>

            <!-- Icon -->
            <div class={`text-6xl mb-6 ${success ? "animate-bounce" : ""}`}>
                {success ? "âœ¨" : "ðŸ”’"}
            </div>

            <!-- Title -->
            <h2
                class={`text-3xl font-black mb-4 ${success ? "text-emerald-400" : "text-rose-400"}`}
            >
                {success ? "Email Verified!" : "Verification Failed"}
            </h2>

            <!-- Message -->
            <p class="text-slate-400 mb-8 text-sm leading-relaxed">{message}</p>

            <!-- CTA Button -->
            <a
                href="/"
                class={`inline-block font-bold px-10 py-4 rounded-xl transition-all shadow-lg ${
                    success
                        ? "bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 shadow-emerald-500/20"
                        : "bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 shadow-blue-500/20"
                } text-white`}
            >
                {success ? "Start Using Multi-Tools" : "Back to Home"}
            </a>
        </div>
    </div>
</AuthLayout>
